# AWS CloudWatch Metrics Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [development]: metrics   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fawscloudwatchmetrics%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fawscloudwatchmetrics) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fawscloudwatchmetrics%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fawscloudwatchmetrics) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@jpkrohling](https://www.github.com/jpkrohling) |

[development]: https://github.com/open-telemetry/opentelemetry-collector#development
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

Receives CloudWatch metrics from [AWS CloudWatch](https://aws.amazon.com/cloudwatch/) via the [AWS SDK for CloudWatch Metrics](https://docs.aws.amazon.com/sdk-for-go/api/service/cloudwatch/)

## Getting Started

This receiver uses the [AWS SDK](https://aws.github.io/aws-sdk-go-v2/docs/configuring-sdk/) as mode of authentication, which includes [Profile](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html) and [IMDS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html) authentication for EC2 instances.

By default the receiver collects *no* metrics.

## Configuration

### Top Level Parameters

| Parameter       | Notes      | type   | Description                                                                                                                                                                                                                                                                       |
| --------------- | ---------- | ------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `region`        | *required* | string | The AWS recognized region string  |
| `profile`       | *optional* | string | The AWS profile used to authenticate, if none is specified the default is chosen from the list of profiles  |
| `IMDSEndpoint`  | *optional* | string | The IMDS endpoint to authenticate to AWS  |                                                                                                                                 
| `poll_interval`   | `default=5m` | duration   | The duration waiting in between requests | 
| `metrics`          | *required* | `Metrics` | Configuration for metrics ingestion of this receiver    |

### Metrics Parameters


| Parameter                | Notes        | type                   | Description                                                                                |
| ------------------------ | ------------ | ---------------------- | ------------------------------------------------------------------------------------------ |
| `group`                 | *one key required*   | `See group parameters` | Configuration for named metrics |
| `autodiscover`        | *one key required* | `See autodiscover parameters` | Configuration for autodiscovery of metrics


### Group Parameters

| Parameter                | Notes        | type                   | Description                                                                                |
| ------------------------ | ------------ | ---------------------- | ------------------------------------------------------------------------------------------ |
| `namespace`                 | *required*   | `string` | AWS Metric namespace, all AWS namespaces are prefixed with `AWS`, eg: `AWS/EC2` for EC2 metrics |
| `period` | `default=5m` | duration | Aggregation period | 
| `name` | *required* | `See named metric config` | Configuration for metric name



### Named Metric Parameters
| Parameter                | Notes        | type                   | Description                                                                                |
| ------------------------ | ------------ | ---------------------- | ------------------------------------------------------------------------------------------ |
| `metric_name` | required | string | name of metric |
| `aws_aggregation` | `default=sum` | string | type of AWS aggregation, eg: sum, min, max, average |
| `dimensions` | *optional* | `see Dimensions Parameters` | Configuration for metric dimensions. You should note AWS CloudWatch cannot unroll metrics, and so some dimensions are required for metrics data to be returned such a `InstanceId` for EC2 metrics |




### Dimension Parameters

| Parameter                | Notes        | type                   | Description                                                                                |
| ------------------------ | ------------ | ---------------------- | ------------------------------------------------------------------------------------------ |
| `name`                 | *required*   | `string` | Dimensions name, can't start with a colon |
| `value` | *required* | `string` | Dimension value |


#### Named Example

```yaml
region: "eu-west-2"
profile: "my_profile"
imds_endpoint: ""
poll_interval: "1m"
metrics:
  group:
    - namespace: "AWS/EC2"
      period: "5m"
      name:
        - metric_name: "CPUUtilization"
          aws_aggregation: "Average"
          dimensions:
            - Name: "InstanceId"
              Value: "i-1234567890abcdef0"
    - namespace: "AWS/EC2"
      period: "1h"
      name:
        - metric_name: "DiskReadBytes"
          aws_aggregation: "Sum"
          dimensions:
            - Name: "InstanceId"
              Value: "i-9876543210abcdef0"

```

## Autodiscovery Example

```yaml

region: "us-west-2"
profile: "my_profile"
imds_endpoint: ""
poll_interval: "1m"
metrics:
  autodiscover:
    namespace: "AWS/EC2"
    limit: 100
    aws_aggregation: "Average"
    period: "5m"
    dimensions:
      - Name: "InstanceId"
        Value: "i-1234567890abcdef0"
      - Name: "InstanceId"
        Value: "i-9876543210abcdef0"


processors:

exporters:
  debug:
    verbosity: detailed

service:
  pipelines:
    metrics:
      receivers: [awscloudwatchmetrics]
      processors: []
      exporters: [debug]
```

## AWS Costs

This receiver uses the [GetMetricData](https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_GetMetricData.html) API call, this call is *not* in the AWS free tier. Please refer to [Amazon's pricing](https://aws.amazon.com/cloudwatch/pricing/) for further information about expected costs.

## Features not supported

- This receiver currently does not support [metric math](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html) to return new time series based on a mathematical expressions.

- For better performance AWS recommends modifying the `StartTime` and `EndTime` to align with the metric's period and start/end of the hour. For example, a metric with a period of 5 minutes and a start-time of 18:55 can get better [performance than specifying a start-time of 18:51](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudwatch/client/get_metric_data.html). This receiver does not currently implement this logic.

## Troubleshooting

### My metrics are not being discovered

AWS CloudWatch [ListMetrics API call](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudwatch/list-metrics.html) does not return information about metrics if those metrics haven't had any updates in the past two weeks

### My metrics are intermittent / not receiving any metrics

Try a bigger `poll_interval`. CloudWatch returns no data if the period of the metric, by default for AWS supplied metrics this is 300 seconds (5 minutes), is less than the `poll_interval`. Try out a period of 600 seconds and a poll interval of 600 seconds.

### IAM Permission errors

Make sure your IAM role/user has the required permissions:

```yaml
"cloudwatch:GetMetricData",
"cloudwatch:ListMetrics"
```

The following IAM permissions are required for transit gateways to work:

```yaml
"ec2:DescribeTags",
"ec2:DescribeInstances",
"ec2:DescribeRegions",
"ec2:DescribeTransitGateway*"
```

